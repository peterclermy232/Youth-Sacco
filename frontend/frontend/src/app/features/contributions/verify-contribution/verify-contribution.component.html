<div class="verify-container">
  @if (loading) {
    <div class="loading-container">
      <mat-spinner></mat-spinner>
    </div>
  } @else if (contribution) {
    <mat-card class="verify-card">
      <mat-card-header>
        <button mat-icon-button routerLink="/admin" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-content">
          <mat-card-title>Verify Contribution</mat-card-title>
          <mat-card-subtitle>Review and approve/reject this contribution</mat-card-subtitle>
        </div>
      </mat-card-header>

      <mat-card-content>
        <div class="contribution-details">
          <h3>Contribution Details</h3>

          <div class="detail-row">
            <span class="label">Member:</span>
            <span class="value">
              {{ contribution.member_details?.first_name }} {{ contribution.member_details?.last_name }}
            </span>
          </div>

          <div class="detail-row">
            <span class="label">Phone Number:</span>
            <span class="value">{{ contribution.member_details?.phone_number }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="detail-row">
            <span class="label">Type:</span>
            <span class="value">{{ contribution.contribution_type_name }}</span>
          </div>

          <div class="detail-row highlight">
            <span class="label">Amount:</span>
            <span class="value amount">KES {{ contribution.amount }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="detail-row">
            <span class="label">M-Pesa Code:</span>
            <span class="value code">{{ contribution.mpesa_transaction_code }}</span>
          </div>

          <div class="detail-row">
            <span class="label">M-Pesa Phone:</span>
            <span class="value">{{ contribution.mpesa_phone_number }}</span>
          </div>

          <mat-divider></mat-divider>

          <div class="detail-row">
            <span class="label">Submitted:</span>
            <span class="value">{{ contribution.submitted_at | date:'medium' }}</span>
          </div>

          @if (contribution.notes) {
            <div class="detail-row notes">
              <span class="label">Notes:</span>
              <span class="value">{{ contribution.notes }}</span>
            </div>
          }
        </div>

        <form [formGroup]="verificationForm" (ngSubmit)="onSubmit()">
          <h3>Verification Decision</h3>

          <mat-radio-group formControlName="status" class="radio-group">
            <mat-radio-button value="VERIFIED" color="primary">
              <mat-icon>check_circle</mat-icon>
              Verify - Approve this contribution
            </mat-radio-button>
            <mat-radio-button value="REJECTED" color="warn">
              <mat-icon>cancel</mat-icon>
              Reject - Decline this contribution
            </mat-radio-button>
          </mat-radio-group>

          @if (verificationForm.get('status')?.value === 'REJECTED') {
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rejection Reason</mat-label>
              <textarea
                matInput
                formControlName="rejection_reason"
                rows="3"
                placeholder="Explain why this contribution is being rejected..."
              ></textarea>
              @if (verificationForm.get('rejection_reason')?.hasError('required') && verificationForm.get('rejection_reason')?.touched) {
                <mat-error>Rejection reason is required</mat-error>
              }
            </mat-form-field>
          }

          <div class="button-row">
            <button mat-raised-button type="button" (click)="cancel()">
              Cancel
            </button>
            <button
              mat-raised-button
              [color]="verificationForm.get('status')?.value === 'VERIFIED' ? 'primary' : 'warn'"
              type="submit"
              [disabled]="submitting"
            >
              @if (submitting) {
                <mat-spinner diameter="20"></mat-spinner>
              } @else {
                {{ verificationForm.get('status')?.value === 'VERIFIED' ? 'Verify Contribution' : 'Reject Contribution' }}
              }
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
